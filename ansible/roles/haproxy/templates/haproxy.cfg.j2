# ansible/roles/haproxy/templates/haproxy.cfg.j2
global
    log 127.0.0.1:514 local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend k8s_frontend
    bind *:6443
    mode tcp
    default_backend k8s_backend

backend k8s_backend
    mode tcp
    balance roundrobin
{% for host in groups['kube_control_plane'] %}
    server master{{ loop.index }} {{ host }}:6443 check
{% endfor %}

listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 30s
